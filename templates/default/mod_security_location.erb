# Generated by Chef for <%= @fqdn || node['fqdn'] %>
# Local modifications will be overwritten.
#

server {
  server_name <%= @server_name %>;
  listen <%= @listen_port %>;
  return 301 https://$host:<%= @ssl_listen_port %>$request_uri;
}

server {
  server_name <%= @server_name -%>;

  set_real_ip_from 0.0.0.0/0;
  real_ip_header X-forwarded-For;
  real_ip_recursive on;

  listen <%= @ssl_listen_port %> ssl;

  ssl_certificate <%= @ssl_certificate %>;
  ssl_certificate_key <%= @ssl_certificate_key %>;

  ssl_session_timeout 5m;
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers !aNULL:!eNULL:FIPS@STRENGTH:!MD5:!DSS:!DES:!DH;
  ssl_prefer_server_ciphers on;

  location / {
    ModSecurityEnabled on;
    ModSecurityConfig <%= @modsecurity_config %>;
    proxy_pass http://localhost:<%= @forward_port %>;
    proxy_read_timeout <%= @timeout || '180' %>s;

    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }
}
